Crons
=====

Overview
--------

This spec describes **crons** — scheduled, headless missions that the daemon launches automatically on a crontab schedule. Crons enable autonomous background work: agents run on a schedule without user intervention, and the user can check results via `cron history` or by resuming completed missions.


Prerequisites
-------------

### Verify `--print` Resumability

Before implementing crons, verify that headless Claude sessions can be resumed:

```bash
claude --print -p "Say hello and remember the number 42"
claude -c -p "What number did I ask you to remember?"
```

If `-c` successfully continues the `--print` conversation, proceed with this spec. If not, investigate alternatives:

- `claude -p <prompt>` with stdin closed (may behave differently)
- A different flag combination
- Filing a feature request with Anthropic

**This is a blocker.** Do not implement crons until headless resumability is confirmed.


Crons
-----

### Definition

A cron is a named, scheduled rule that tells the daemon to create and launch a headless mission at specific times. Each cron definition contains:

| Field | Required | Description |
|-------|----------|-------------|
| `id` | yes | UUID that uniquely identifies this cron across time. Auto-generated by `cron new`. |
| `schedule` | yes | Standard 5-field crontab expression (`minute hour day-of-month month day-of-week`). |
| `agent` | yes | Agent template to use (canonical `github.com/owner/repo` format). |
| `prompt` | yes | The prompt text to pass to Claude. |
| `description` | no | Human-readable description of what this cron does. Displayed in `cron ls`. |
| `git` | no | A Git repo from the agenc repo library to copy into the mission's workspace. |
| `timeout` | no | Maximum runtime before the mission is killed. Format: `30m`, `2h`, `1h30m`. Default: `1h`. |
| `overlap` | no | Policy when previous run is still active: `skip` (default) or `allow`. |
| `enabled` | no | Boolean. Disabled crons are retained in config but do not fire. Default: `true`. |

### Timezone Behavior

All crontab expressions are evaluated against the **system's local time**. The daemon uses `time.Now()` truncated to the minute. Agenc does not support per-cron timezone configuration; if you need a cron to fire at a specific time in a different timezone, convert the schedule to local time.

### Storage

Cron definitions live in `config.yml` under a top-level `crons` key:

```yaml
crons:
  maxConcurrent: 5  # optional, default: 10

  daily-git-sync:
    id: "550e8400-e29b-41d4-a716-446655440000"  # auto-generated by cron new
    description: "Check all repos for unpushed changes and report"
    schedule: "0 9 * * *"
    agent: github.com/mieubrisse/git-sync-agent
    prompt: "Check all repos for unpushed changes"
    timeout: 30m
    overlap: skip

  weekly-todoist-cleanup:
    id: "6ba7b810-9dad-11d1-80b4-00c04fd430c8"  # auto-generated by cron new
    description: "Organize Todoist inbox into projects"
    schedule: "0 10 * * 1"
    agent: github.com/mieubrisse/todoist-agent
    prompt: "Clear the Todoist inbox and organize tasks into appropriate projects"
    git: github.com/mieubrisse/todoist-config
    timeout: 1h
    overlap: skip
```

### Global Settings

The `crons` section supports one global setting:

- **`maxConcurrent`** — Maximum number of headless cron missions that can run simultaneously. Default: `10`. When the limit is reached, new cron fires are skipped (not queued) and a warning is logged.

### CLI Commands

Crons are managed through `agenc cron` subcommands:

| Command | Description |
|---------|-------------|
| `agenc cron new` | Interactive wizard: prompts for name, schedule, agent template (fzf picker), prompt, and optional fields. Validates inputs and writes to config.yml. |
| `agenc cron ls` | Lists all crons with name, schedule, agent, enabled, last run status, and next fire time. |
| `agenc cron rm <name>` | Removes a cron from config.yml. Does not affect missions already created by the cron. |
| `agenc cron enable <name>` | Sets `enabled: true` for the named cron. |
| `agenc cron disable <name>` | Sets `enabled: false` for the named cron. |
| `agenc cron run <name>` | Immediately fires the cron (creates mission, launches Claude). Ignores `enabled` status. Records run with `triggered_by='manual'`. Useful for testing. |
| `agenc cron logs <name>` | Tails the `claude-output.log` of the most recent mission for this cron. Supports `--follow` flag. |
| `agenc cron history <name>` | Shows recent runs for this cron with timestamps, duration, and exit status. |

### `cron ls` Output Format

```
NAME             SCHEDULE      ENABLED  LAST RUN              STATUS    NEXT RUN
daily-git-sync   0 9 * * *     yes      2025-01-15 09:00      success   2025-01-16 09:00
weekly-review    0 10 * * 1    yes      2025-01-13 10:00      failed    2025-01-20 10:00
hourly-check     0 * * * *     yes      2025-01-15 14:00      running   2025-01-15 15:00
disabled-cron    0 6 * * *     no       2025-01-10 06:00      success   -
```

Use `--verbose` or `-v` to include description and agent columns.

### Crontab Parsing Library

Use [`adhocore/gronx`](https://github.com/adhocore/gronx) (v1.19.6+, MIT license) for crontab expression parsing and evaluation. Key API:

- `gronx.New().IsValid(expr)` — validate a cron expression.
- `gronx.New().IsDue(expr, referenceTime)` — check if an expression matches a specific time.
- `gronx.NextTickAfter(expr, refTime, false)` — find the next fire time after a reference.

### Validation

**On `cron new`:**
- Cron name must be non-empty and contain only `[a-zA-Z0-9_-]`.
- Cron name must be unique (not already defined in config).
- Schedule must be a valid 5-field crontab expression.
- Agent must exist in `agentTemplates` section of config.yml.
- Git repo (if specified) must exist in `syncedRepos` section of config.yml.
- Timeout must be a valid Go duration string (e.g., `30m`, `1h`, `2h30m`).
- Overlap must be one of: `skip`, `allow`.

**On daemon startup:**
- Log warnings for crons with invalid agent or git references (don't crash).
- Invalid crons are skipped during scheduling.

**On cron fire:**
- If agent template doesn't exist: skip, log error, record failed run.
- If git repo doesn't exist: skip, log error, record failed run.

### Daemon Scheduling

The daemon gains a new background goroutine: the **cron scheduler**.

**Cycle:** Every 60 seconds.

**Behavior:**

1. Read the `crons` section of `config.yml`.
2. Get the current time, truncated to the minute.
3. Count currently running headless missions (wrappers). If >= `maxConcurrent`, log a warning and skip this cycle.
4. For each enabled cron with valid references, evaluate the crontab expression using `IsDue(expr, now)`.
5. For each cron whose schedule matches:
   a. **Double-fire guard:** Check `missions` table. If a mission exists for this cron with `created_at` within the current minute, skip (already fired).
   b. **Overlap policy:**
      - `skip`: If a mission exists with `finished_at IS NULL`, skip this fire and log it.
      - `allow`: Proceed regardless of running missions.
   c. **Concurrency check:** If running headless missions >= `maxConcurrent`, skip and log.
   d. **Spawn headless mission:** Fork `agenc mission new --headless --cron-id <id> --cron-name <name> --timeout <timeout> --agent <agent> --git <git> -p <prompt>`.
      The subprocess handles everything: mission creation (with cron metadata), Claude invocation, heartbeating, output capture, secrets, timeout enforcement, and updating the mission on exit.
   e. **Track process:** Store subprocess PID and mission ID in daemon's in-memory map for cleanup.
6. **Completion handling:** When a wrapper process exits, the daemon removes it from the in-memory tracking map.

   Note: The wrapper is responsible for updating the mission's `finished_at`, `exit_code`, and `exit_reason` before it exits.

**Missed runs:** If the daemon was not running when a cron was scheduled to fire, the run is skipped. The daemon does not backfill missed runs. This matches standard cron behavior.

### Daemon Startup: Orphan Handling

On daemon startup, handle cron missions that may have been orphaned by a previous daemon crash:

1. Query `missions` for rows where `cron_id IS NOT NULL` and `finished_at IS NULL`.
2. For each orphaned mission:
   a. Check if the wrapper process is still running (read PID from mission's `pid` file, check if process exists).
   b. If running: adopt the wrapper (add to in-memory tracking map). The wrapper continues handling heartbeats and will update the mission when it finishes.
   c. If not running: update the mission with `finished_at = now`, `exit_code = NULL`, `exit_reason = 'orphaned'`.

### Daemon Shutdown

On `SIGTERM` or `SIGINT`:

1. Stop the cron scheduler loop.
2. For each running headless wrapper process:
   a. Send `SIGINT` to the wrapper. The wrapper will forward this to Claude and handle graceful shutdown.
   b. Wait up to 60 seconds for wrapper to exit (wrapper has its own 30-second grace period for Claude).
   c. If wrapper still running, send `SIGKILL`.
3. Exit.

Note: The wrapper is responsible for updating the mission on shutdown. If the wrapper is killed before it can update the DB, the orphan handling on next daemon startup will mark it as `orphaned`.

### Headless Mode

The `agenc mission new` command gains two new flags for headless execution:

- **`--headless`** — Run without terminal interaction. Changes behavior as described below.
- **`--timeout <duration>`** — Maximum runtime before killing Claude (e.g., `30m`, `1h`). Only valid with `--headless`. Default: `1h`.

**Example (manual headless mission):**
```bash
agenc mission new --headless --timeout 30m -p "Check all repos for unpushed changes"
```

| Aspect | Interactive Mode | Headless Mode (`--headless`) |
|--------|------------------|------------------------------|
| Claude command | `claude <prompt>` or `claude -c` | `claude --print -p <prompt>` |
| stdin | Wired to user's terminal | `/dev/null` |
| stdout/stderr | Wired to user's terminal | Captured to `claude-output.log` |
| Spawned by | User (foreground) or daemon (background) | User or daemon |
| Template live-reload | Yes (fsnotify watches) | No (single-shot execution) |
| Timeout enforcement | No | Yes (kills Claude after timeout) |
| On completion | Wrapper exits, user returns to shell | Wrapper updates mission (`finished_at`, `exit_code`, `exit_reason`), then exits |

**Shared behavior (both modes):**
- Heartbeat updates every 30 seconds
- Secrets handling via `op run --env-file` if `secrets.env` exists
- Sets `AGENC_MISSION_UUID` environment variable
- Writes PID to mission's `pid` file

**On headless completion:** The wrapper updates the mission's `finished_at`, `exit_code`, and `exit_reason` before exiting. This ensures the DB is consistent even if the daemon crashes.

Headless missions reuse the same directory structure, DB record, and `AGENC_MISSION_UUID` as interactive missions. Users can `mission resume` a completed headless mission to continue interactively.

### Log Rotation

The wrapper (in headless mode) manages `claude-output.log` with size-based rotation:

- Maximum size: 10 MB
- On rotation: rename to `.1`, shift existing `.1` to `.2`, etc.
- Keep last 3 rotated files (`.1`, `.2`, `.3`)
- Rotation checked at mission start and periodically during execution

### Database Changes

**Add columns to missions table:**

```sql
ALTER TABLE missions ADD COLUMN cron_id TEXT;           -- UUID from cron definition, NULL if not cron-spawned
ALTER TABLE missions ADD COLUMN cron_name TEXT;         -- name snapshot at creation, NULL if not cron-spawned
ALTER TABLE missions ADD COLUMN triggered_by TEXT;      -- 'scheduled', 'manual', or NULL
ALTER TABLE missions ADD COLUMN finished_at TEXT;       -- when mission completed
ALTER TABLE missions ADD COLUMN exit_code INTEGER;      -- process exit code
ALTER TABLE missions ADD COLUMN exit_reason TEXT;       -- 'success', 'error', 'timeout', 'killed', 'orphaned', 'daemon_shutdown'
```

**Add index for cron queries:**

```sql
CREATE INDEX idx_missions_cron ON missions(cron_id, created_at DESC) WHERE cron_id IS NOT NULL;
```


CLI Commands Summary
--------------------

### `agenc cron`

| Command | Description |
|---------|-------------|
| `agenc cron new` | Interactive wizard for creating a cron. |
| `agenc cron ls` | List all crons with status and next fire time. |
| `agenc cron rm <name>` | Remove a cron from config. |
| `agenc cron enable <name>` | Enable a cron. |
| `agenc cron disable <name>` | Disable a cron. |
| `agenc cron run <name>` | Manually trigger a cron (for testing). |
| `agenc cron logs <name>` | View output log of most recent run. |
| `agenc cron history <name>` | Show recent runs with status. |

### `agenc daemon`

| Command | Description |
|---------|-------------|
| `agenc daemon status` | Show daemon state: running goroutines, last activity, running headless missions. |

### Enhanced `agenc mission ls`

Add `--cron <name>` flag to filter missions by cron:

```
agenc mission ls --cron daily-git-sync
```

Display cron name in output when present.


Database Schema Summary
-----------------------

```sql
-- Cron-related columns on missions table
ALTER TABLE missions ADD COLUMN cron_id TEXT;           -- UUID from cron definition
ALTER TABLE missions ADD COLUMN cron_name TEXT;         -- name snapshot at creation
ALTER TABLE missions ADD COLUMN triggered_by TEXT;      -- 'scheduled', 'manual', or NULL
ALTER TABLE missions ADD COLUMN finished_at TEXT;       -- when mission completed
ALTER TABLE missions ADD COLUMN exit_code INTEGER;      -- process exit code
ALTER TABLE missions ADD COLUMN exit_reason TEXT;       -- 'success', 'error', 'timeout', etc.

CREATE INDEX idx_missions_cron ON missions(cron_id, created_at DESC) WHERE cron_id IS NOT NULL;
```


Changes to Existing Components
------------------------------

### Daemon

- **New goroutine:** Cron scheduler (60-second cycle). Evaluates cron expressions and spawns `mission new --headless` subprocesses.
- **Process tracking:** Maintain in-memory map of running headless mission PIDs.
- **Orphan handling:** On startup, adopt running missions or mark orphaned runs.
- **Shutdown cleanup:** Send SIGINT to running missions, wait for graceful exit.
- **New command:** `agenc daemon status` to show running goroutines, last activity, and running headless missions.

### `agenc mission new`

- **New `--headless` flag:** Run without terminal interaction.
- **New `--timeout` flag:** Maximum runtime for headless missions (e.g., `30m`, `1h`). Only valid with `--headless`.
- Headless mode changes: Claude invoked with `--print`, stdout/stderr captured to `claude-output.log`, timeout enforcement, no template live-reload.

### Mission Wrapper

- **Headless support:** When `mission new --headless` is used, wrapper runs in headless mode.
- **Timeout enforcement (headless):** Kill Claude after configured timeout.
- **Output capture (headless):** Write stdout/stderr to `claude-output.log` with rotation.
- **Completion tracking:** Update mission's `finished_at`, `exit_code`, and `exit_reason` on exit.
- **Environment variable:** Set `AGENC_MISSION_UUID` (both modes).

### Mission Directory

```
$AGENC_DIRPATH/missions/<uuid>/
    pid
    claude-state
    template-commit
    wrapper.log
    claude-output.log      # headless only
    claude-output.log.1    # rotated
    claude-output.log.2
    claude-output.log.3
    agent/
        ...
```

### `agenc mission ls`

- Display cron name for cron-spawned missions.
- Add `--cron <name>` filter flag.


What Does NOT Change
--------------------

- Existing mission lifecycle (new, resume, archive, stop, rm, nuke).
- Mission wrapper state machine for interactive missions.
- Template updater daemon goroutine.
- The `agenc template` and `agenc repo` command families.
- Daemon's repo update loop behavior.


Implementation Phases
---------------------

**Phase 0: Prerequisite verification**
- Verify `claude --print` conversations can be resumed with `claude -c`.
- Document findings. If it doesn't work, investigate alternatives before proceeding.

**Phase 1: Cron infrastructure**
- Add cron columns to missions table (`cron_id`, `cron_name`, `triggered_by`, `finished_at`, `exit_code`, `exit_reason`).
- Parse `crons` section from config.yml with validation.
- Implement `agenc cron new/ls/rm/enable/disable`.

**Phase 2: Headless mode**
- Add `--headless`, `--timeout`, `--cron-id`, and `--cron-name` flags to `mission new`.
- Implement output capture to `claude-output.log` with rotation.
- Implement timeout enforcement (SIGTERM → SIGKILL).
- Implement mission completion tracking (`finished_at`, `exit_code`, `exit_reason`).
- Set `AGENC_MISSION_UUID` environment variable in wrapper.
- Test headless mode independently (`mission new --headless`) before integrating with daemon.

**Phase 3: Cron execution**
- Implement daemon cron scheduler goroutine.
- Implement wrapper spawning for headless missions.
- Implement overlap policies.
- Implement orphan handling on daemon startup.
- Implement graceful shutdown (signal wrappers).

**Phase 4: Cron observability**
- Implement `agenc cron run <name>` (manual trigger with `triggered_by='manual'`).
- Implement `agenc cron logs <name>`.
- Implement `agenc cron history <name>`.
- Implement `agenc daemon status`.
- Add `--cron` filter to `mission ls`.


Design Decisions
----------------

The following decisions were made during spec development:

### Notification of Cron Failures

**Decision:** Do nothing. Users check status manually via `cron ls` or `cron history`.

**Rationale:** Keeps the initial implementation simple. Notification mechanisms (auto-messaging, webhooks) can be added later if needed.

### Daemon Observability

**Decision:** Add `agenc daemon status` command.

**Rationale:** Provides useful debugging information (running goroutines, last activity, running headless missions) without overengineering. Structured logging and health endpoints can be added later if needed.

### Retention Policy

**Decision:** No retention policy for crons. Mission retention is handled separately.

**Rationale:** Decouples concerns. Cron definitions focus on scheduling; mission lifecycle management is a separate feature.

### Manual Cron Runs

**Decision:** Track manual runs with `triggered_by='manual'` on the mission.

**Rationale:** Manual runs (`agenc cron run <name>`) appear in `cron history` but can be distinguished from scheduled runs. Useful for testing and audit trails.

### Cron Identity

**Decision:** Each cron has a UUID (`id` field) that uniquely identifies it across time. Missions store both `cron_id` and `cron_name` (snapshot at creation).

**Rationale:** Follows the Kubernetes model where names are human-readable identifiers that can be reused after deletion, while UIDs provide unique identity across the cluster's lifetime. If a user deletes a cron and creates a new one with the same name, the new cron gets a new UUID, so run history remains correctly associated with the original cron. The name snapshot ensures `cron history` shows meaningful names even for deleted crons.

### No Separate `cron_runs` Table

**Decision:** Store all cron run data on the `missions` table instead of a separate `cron_runs` table.

**Rationale:** Simplifies the data model. A cron run *is* a mission — there's no meaningful distinction. Cron metadata (`cron_id`, `cron_name`, `triggered_by`) and completion data (`finished_at`, `exit_code`, `exit_reason`) belong on the mission itself.

### Messaging and Inbox

**Decision:** Deferred to a future spec.

**Rationale:** The initial cron implementation focuses on headless execution. Agent-to-user messaging and inbox can be designed separately once crons are working.
