{"id":"agent-r4i","title":"Add git pre-commit hook and make setup/check targets","description":"Add a git pre-commit hook that enforces code quality checks (formatting, vetting, tests) on every commit. This replaces the current approach of relying on agents to voluntarily run 'make build'.\n\n## Context\n\nAgents working in this repo frequently skip quality checks before committing. The current CLAUDE.md tells them to use 'make build', but this is advisory — there is no enforcement. A git pre-commit hook provides structural enforcement that cannot be bypassed.\n\nThe library repo copy (in ~/.agenc/repos/) is rsync'd into mission directories via CopyRepo (internal/mission/repo.go:100). Since rsync copies .git/config, any local git config (like core.hooksPath) set in the library copy propagates to all mission clones automatically. This means setting up hooks in the library copy is sufficient — no per-mission setup needed.\n\n## Implementation Steps\n\n### Step 0: Fix pre-existing test failures\n\nTwo test suites currently fail. These MUST be fixed before the hook is added, otherwise no one can commit (including the commit that adds the hook).\n\n1. internal/claudeconfig/prime_content_test.go:40 — TestGetPrimeContent fails because prime_content.md doesn't contain \"agenc daemon\". The generated content is stale. Fix: run 'make genskill' to regenerate, then check if the test expectation or the generator needs updating. The \"agenc daemon\" command group may have been renamed or removed.\n\n2. internal/launchd/plist_test.go:211 — TestCronToPlistFilename fails because CronToPlistFilename() (plist.go:161) doesn't sanitize its input. It returns the cron name verbatim in the filename. The test expects spaces replaced with hyphens and special chars stripped. Fix: add sanitization to CronToPlistFilename() — replace spaces with hyphens, strip characters that aren't alphanumeric/hyphen/underscore.\n\n### Step 1: Create 'make check' target\n\nAdd a 'check' target to the Makefile that runs the quality gates WITHOUT binary compilation, genskill, or docs generation:\n\n```makefile\ncheck:\n\t@test -f internal/claudeconfig/prime_content.md || touch internal/claudeconfig/prime_content.md\n\t@echo \"Checking code formatting...\"\n\t@unformatted=$$(gofmt -l .); \\\n\tif [ -n \"$$unformatted\" ]; then \\\n\t\techo \"Files need formatting:\"; \\\n\t\techo \"$$unformatted\"; \\\n\t\techo \"\"; \\\n\t\techo \"Run: gofmt -w .\"; \\\n\t\texit 1; \\\n\tfi\n\t@echo \"Formatting OK\"\n\t@echo \"Running go vet...\"\n\t@go vet ./...\n\t@echo \"Static analysis OK\"\n\t@echo \"Running tests...\"\n\t@go test ./...\n\t@echo \"Tests passed\"\n```\n\nThe prime_content.md touch is needed because go vet/test will fail on a fresh checkout without the embed placeholder.\n\nThen refactor 'make build' to depend on 'check' instead of inlining the same steps:\n\n```makefile\nbuild: genskill docs setup check\n\t@echo \"Building agenc...\"\n\t@go build -ldflags \"$(LDFLAGS)\" -o agenc .\n\t@echo \"Build complete\"\n```\n\n### Step 2: Create 'make setup' target\n\n```makefile\nsetup:\n\t@if git rev-parse --git-dir \u003e/dev/null 2\u003e\u00261; then \\\n\t\tcurrent=$$(git config core.hooksPath 2\u003e/dev/null); \\\n\t\tif [ \"$$current\" != \".githooks\" ]; then \\\n\t\t\tgit config core.hooksPath .githooks; \\\n\t\t\techo \"Git hooks configured (.githooks/)\"; \\\n\t\tfi; \\\n\tfi\n```\n\nProperties: idempotent (no-op if already set), CI-safe (no-op if no .git), silent on repeat runs.\n\n'make build' depends on 'setup' so hooks auto-activate on first build.\n\n### Step 3: Create .githooks/pre-commit\n\nCreate .githooks/pre-commit (must be executable: chmod +x):\n\n```bash\n#!/usr/bin/env bash\nset -euo pipefail\n\n# Run quality checks (formatting, vet, tests)\nmake check\n\n# Chain to beads pre-commit hook if bd is available\nif command -v bd \u003e/dev/null 2\u003e\u00261; then\n    bd hook pre-commit \"$@\"\nfi\n```\n\n### Step 4: Create shims for all other beads hooks\n\nSince core.hooksPath overrides .git/hooks/ entirely, we need shims in .githooks/ for ALL five beads hooks, not just pre-commit. The other four are pass-through shims.\n\nCreate these files (all chmod +x):\n\n.githooks/prepare-commit-msg:\n```bash\n#!/usr/bin/env bash\nif command -v bd \u003e/dev/null 2\u003e\u00261; then\n    exec bd hook prepare-commit-msg \"$@\"\nfi\n```\n\n.githooks/pre-push:\n```bash\n#!/usr/bin/env bash\nif command -v bd \u003e/dev/null 2\u003e\u00261; then\n    exec bd hook pre-push \"$@\"\nfi\n```\n\n.githooks/post-checkout:\n```bash\n#!/usr/bin/env bash\nif command -v bd \u003e/dev/null 2\u003e\u00261; then\n    exec bd hook post-checkout \"$@\"\nfi\n```\n\n.githooks/post-merge:\n```bash\n#!/usr/bin/env bash\nif command -v bd \u003e/dev/null 2\u003e\u00261; then\n    exec bd hook post-merge \"$@\"\nfi\n```\n\nNote: the beads hooks in .beads/hooks/ use two different shim versions (v1 uses 'bd hooks run', v2 uses 'bd hook'). Use the v2 pattern ('bd hook \u003cname\u003e') for all shims since it is the newer API.\n\n### Step 5: Update CLAUDE.md\n\nUpdate the \"Building the Binary\" section to document:\n- 'make setup' is run automatically by 'make build' on first invocation (sets up git hooks)\n- 'make check' runs formatting, vetting, and tests (no binary)\n- 'make build' runs check + compiles the binary (the canonical verification command)\n- The pre-commit hook runs 'make check' automatically on every git commit\n- Do NOT use --no-verify to skip hooks\n\n## Testing\n\nAfter implementation, verify:\n1. 'make check' passes independently\n2. 'make setup' is idempotent (run twice, second is silent)\n3. 'make build' runs setup + check + compile\n4. 'git commit' with a formatting error is rejected by the hook\n5. 'git commit' with passing code succeeds (and beads hook still runs)\n6. A fresh clone + 'make build' activates hooks automatically","status":"open","priority":2,"issue_type":"feature","owner":"1142185+mieubrisse@users.noreply.github.com","created_at":"2026-02-27T17:48:10Z","created_by":"Kevin Today","updated_at":"2026-02-27T17:48:10Z"}
